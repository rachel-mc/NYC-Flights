---
title: "NYC Flights - Supplementary Information"
author: "Ellen Creed, Rachel McInerney, Si√∫n Mulcahy, Conor Thompson"
date: "`r format(Sys.time(), '%X %d %B, %Y')`"
output:
  html_document:
    code_folding: hide
---

```{r, message = FALSE, warning = FALSE}
library(nycflights13)
library(tidyverse)
library(ggplot2)
library(densr)
library(fpp3)
```


```{r, eval = F}
## Exploratory Data Analysis

# Uncomment to produce an autogenerated data summary from dataReporter on your device
# install.packages("dataReporter")
# dataReporter::makeDataReport(flights, replace = TRUE)

# Initial view of data
glimpse(flights)
str(flights)
head(nycflights13::airports)
```

## Additional Tables 

### Question 1

```{r}
flights <- nycflights13::flights[complete.cases(nycflights13::flights[,]),] 

# To get the name of each carrier/airline
airlines <- nycflights13::airlines
filter(airlines, carrier == "AS")
filter(airlines, carrier == "HA")
filter(airlines, carrier == "OO")

average_delay <- flights |>
  group_by(carrier) |>
  summarise(avg_arrival_delay = mean(arr_delay))

# Each airline arranged by average arrival delay in ascending order
average_delay_airline <- average_delay[order(average_delay$avg_arrival_delay), ]
average_delay_airline
```


### Question 2

```{r}
air_num <- flights |>
  group_by(tailnum) |>
  summarise(airtime = median(air_time))

air_time <- air_num$airtime/60

# Sort individual planes by decreasing air_time
air_num |> arrange(desc(airtime))

planes <- nycflights13::planes # # all plane tailnumbers found of the FAA aircraft registry
planes |> filter(tailnum == "N384HA")
```


## More Visualisations

```{r}
# Correlation between Arrival and Departure delays
flights |>
  ggplot(aes(x = dep_delay, y = arr_delay, color = carrier)) +
  geom_point() +
  labs(x = "Departure Delay (minutes)", y = "Arrival Delay (minutes)",
       title = "Scatterplot of Arrival Delay vs. Departure Delay",
       color = "Airline") +
  theme_minimal()
# Expected linear relationship with some noise/variation
```


```{r}
# Scatter plot of Scheduled Departure Time vs Mean distance travelled per plane
# with superimposed Generalised Additive Model
data1 <- flights |>
  group_by(tailnum) |>
  summarise(count = n(), 
            dist = mean(distance), 
            dep = mean(sched_dep_time))


ggplot(data1, aes(x = dist, y = dep)) +
  geom_point(aes(size = count), alpha = 0.25) +
  geom_smooth() +
  scale_size_area() +
  labs(x = "Mean distance (km)",
       y = "Scheduled Departure Time") +
  ggtitle("Scatter plot of Departure Time vs Distance") +
  theme_bw() 
# Flights that have longer journeys tend to leave earlier in the day
```


```{r}
# Obtain names of airports
filter(airports, faa == "JFK")
filter(airports, faa == "LGA")
filter(airports, faa == "EWR")

# Weekday Flight Trends
flights <- flights %>%
  mutate(Date = as.Date(time_hour))

flights_totals_Dateonly <- flights %>% 
  group_by(Date) %>% 
  summarise(total_flights = n()) %>% 
  ungroup()

demand <- flights_totals_Dateonly %>% 
  distinct(Date, .keep_all = TRUE) %>% 
  as_tsibble(index = Date)

demand %>% 
  gg_season(total_flights, period = "week") + 
  theme(legend.position = "none") + 
  labs(x = "Day of the week", y = "Total Flights", title = "Daily Flight Totals across NYC in 2013")
```


```{r}
# Seasonal and Trend decomposition using Loess
dcmp <- flights_totals_Dateonly %>%
  as_tsibble() %>% 
  model(stl = STL(total_flights))

components(dcmp) %>% autoplot
```


```{r, warnings = F}
# Aside: other possible superimposed densities with `densr`
air2 <- create_hist_dens(air_time, type = "gaussian")
air3 <- create_hist_dens(air_time, type = "kde", kernel = "epanechnikov")

par(mfrow = c(1,2))
plot(air2, lwd = 2, border = "darkorchid2", main = "", xlab = "Air Time (in hours)")
plot(air3, lwd = 2, border = "dodgerblue2", lty = 3, main = "", xlab = "Air Time (in hours)")
legend("topright", legend = c("gaussian", "kde"), lty = c(1,3), lwd = c(2,2))
```

