---
title: "NYC Flights"
author: "Ellen Creed, Rachel McInerney, Siun Mulcahy, Conor Thompson"
date: "`r format(Sys.time(), '%X %d %B, %Y')`"
output:
  html_document:
    code_folding: hide
---
 
## Introduction

This data describes all flights that departed New York City in 2013 and is available in R (R Core Team, 2023). 'flights' contains 327,346 observations and 19 variables detailing flight punctuality. Additional information regarding airlines, airports, weather, and
planes is also provided (Wickham, 2021).

## Methods

In order to produce enlightening visualisations of this dataset, data cleaning and wrangling were performed with dplyr (Wickham et al., 2023). We used functions from own `densr` package (McInerney et al., 2024) to create a density histogram. Other plots were generated using ggplot2 (Wickham, 2016).

Motivating questions include:  
1. Is there a particular airline that is more on time than others?  
2. What density distribution does flight duration follow?  
3. Which flight destinations are the most popular?
4. What are the busiest times for flights?

## Results

```{r}
# Install packages
# install.packages('devtools') 
# install.packages('nycflights13')
# devtools::install_github('rachel-mc/densr')
# Load the relevant libraries
suppressMessages(library(nycflights13))
suppressMessages(library(densr))
suppressMessages(library(tidyverse))
suppressMessages(library(ggplot2))
suppressMessages(library(fpp3))


# Remove NAs
flights <- nycflights13::flights[complete.cases(nycflights13::flights[,]),] 
```


### Question 1

Adopted approach: an airline is the most on time if it has the smallest arrival delay

```{r}
average_delay <- flights |>
  group_by(carrier) |>
  summarise(avg_arrival_delay = mean(arr_delay))

ggplot(flights, aes(x = carrier, y = arr_delay)) +
  geom_boxplot(fill = "skyblue", colour = "blue") +
  labs(title = "Arrival Delay by Airline",
       x = "Airline",
       y = "Arrival Delay (minutes)") +
  theme_minimal() +
  ylim(c(-75, 100)) + # to zoom in and account for outliers
  coord_flip() 

filter(nycflights13::airlines, carrier == "AS")
```
This horizontal boxplot representing the average arrival delay in minutes of different carriers from the NYCflights13 library reveals insightful trends. The plot displays that carriers 'AS' (Alaska Airlines) consistently exhibit the least arrival delays. This is closely followed by that of 'HA' giving these airlines the title of being more on time than others and therefore the reputation of being punctual. In contrast, the carriers of 'FL' and 'F9' are on the other end of the spectrum displaying the longest arrival delay meaning that they both are the most delayed airlines in comparison to the others. This is strenghtened by the fact the outliers from these airlines data are all displayed in the postiive side of the x axis implying that there is outliers that are even more delayed than the average delay showing a large variability in the data.
  
  The boxplot's central tendency, as depicted by the position of the median line within the boxes, indicates that both the previously mentioned carriers tend to have lower average dealys compared to other carriers in the dataset. Notably, however, these carriers are only relatively compact in terms of the size of their boxes especially in comparison to the carrier of 'OO' for example, which exhibits a particular small box. THe smaller the size of the box suggests less variability in arrival delay times. Therefore, it is implied that even though 'AS' is the most on time on average there is some slight variability within it's values and the carrier of 'OO' demonstrates the most consistent performance. In addition to this, 'OO' also displays the least amount of outliers reinforcing the idea of it having the most consistent performance.
  
  By focusing solely on the boxplot's interquartile range and median, without considering outliers, the portrayal emphasises the typical delay experience, highlighting 'AS' and 'HA' as favourable choices for travellers prioritising punctuality. On the other hand the 'FL' and 'F9' are poor choices when prioritising punctuality as they display the weakest performance in terms of arrival delay.
##I know I wrote way too much, I thought it would be easier to get rid of things rather than add things to it but let me know if you want me to redo and shorten it:)


'AS' or Alaska Airlines Inc. has the smallest arrival delay in minutes, therefore it tends to be the airline that is the most on time. This is confirmed by the table of carriers arranged by average arrival delay in the Suppl. Info. Negative arrival delay corresponds to time gained during a journey i.e. passengers arrive earlier than scheduled. 


### Question 2

Objective: Find the distributional form for the density of observed air_time using a continuous histogram estimator

```{r}
# Initial data manipulation
# Group the data into individual planes and compute the median air time (more robust)
air_num <- flights |>
  group_by(tailnum) |>
  summarise(airtime = median(air_time))

# Extract the numeric vector converted to hours
air_time <- air_num$airtime/60

# Overlay frequency polygon density estimation
frequency_polygon(air_time)

air_fp <- create_hist_dens(air_time, type = "fp", breaks = "Scott")
suppressWarnings(plot(air_fp, border = "dodgerblue2", lwd = 1.5, lty = 2, 
                      xlab = "Median Air Time in hours per Airline", 
                      main = "Histogram of air_time with Frequency Polygon Density Estimate")) 
```

This density distribution appears to be bimodal, with the frequency polygon coordinates capturing the second significant peak. The distribution is right skewed and we observe positive kurtosis. The most frequent median flight time per plane lasted just over two hours. There are outliers appearing at flight durations of over 10 hours.

The plane that spent the most time in the air in 2013 (on average) was N384HA (see Suppl. Info). Consulting the planes metadata highlighted that this was a 2011 Fixed wing multi-engine manufactured by AIRBUS.

Intuitively, the different routes between airports explain the varying lengths of air time. Additional analysis could uncover which specific planes lie in the quantiles of this data, if external factors such as weather affect air time, and so on.


### Question 3

```{r}

```


### Question 4

Investigate the trends of total flights throughout the year.

```{r, message = FALSE, warning = FALSE}
#Data Manipulation

flights <- flights %>%
  mutate(day_of_year = as.numeric(format(time_hour, "%j")), carrier = as.factor(carrier)) %>% 
  mutate(Date = as.Date(time_hour))


flights_totals <- flights %>% 
  group_by(carrier, day_of_year) %>% 
  summarise(total_flights = n()) %>% 
  ungroup()

flights_sum <- flights_totals %>% 
  group_by(day_of_year) %>% 
  summarise(sum_total = sum(total_flights)) %>% 
  ungroup()

carrier_totals <- aggregate(total_flights ~ carrier , data = flights_totals, FUN = sum)

carrier_totals_ordered <- carrier_totals %>% 
  arrange(desc(total_flights))

top_4_carriers <- head(carrier_totals_ordered, 4)$carrier

flights_totals_Date <- flights %>% 
  group_by(Date, carrier) %>% 
  summarise(total_flights = n()) %>% 
  ungroup()

flights_totals_UA <- flights[flights$carrier == "UA",] %>% 
  group_by(Date) %>% 
  summarise(total_flights = n()) %>% 
  ungroup()
flights_totals_B6 <- flights[flights$carrier == "B6",] %>% 
  group_by(Date) %>% 
  summarise(total_flights = n()) %>% 
  ungroup()
flights_totals_DL <- flights[flights$carrier == "DL",] %>% 
  group_by(Date) %>% 
  summarise(total_flights = n()) %>% 
  ungroup()
flights_totals_EV <- flights[flights$carrier == "EV",] %>% 
  group_by(Date) %>% 
  summarise(total_flights = n()) %>% 
  ungroup()

dcmp_UA <- flights_totals_UA %>% 
  as_tsibble() %>% 
  model(stl = STL(total_flights))
dcmp_B6 <- flights_totals_B6 %>% 
  as_tsibble() %>% 
  model(stl = STL(total_flights))
dcmp_DL <- flights_totals_DL %>% 
  as_tsibble() %>% 
  model(stl = STL(total_flights))
dcmp_EV <- flights_totals_EV %>% 
  as_tsibble() %>% 
  model(stl = STL(total_flights))

comp_UA <- components(dcmp_UA) %>% 
  as_tsibble()
comp_B6 <- components(dcmp_B6) %>% 
  as_tsibble()
comp_DL <- components(dcmp_DL) %>% 
  as_tsibble()
comp_EV <- components(dcmp_EV) %>% 
  as_tsibble()

major_holidays <- as.Date(c("2013-07-04", "2013-09-01", "2013-11-28", "2013-12-25", "2014-01-01" ))
```
```{r}
ggplot(subset(flights_totals_Date, carrier %in% top_4_carriers), aes(x = Date, y = total_flights, colour = carrier)) +
  geom_line(alpha = 0.6) +
  geom_line(data = comp_UA, aes( y = trend), colour = "purple") + 
  geom_line(data = comp_B6, aes( y = trend), colour = "red") +
  geom_line(data = comp_DL, aes( y = trend), colour = "darkgreen") +
  geom_line(data = comp_EV, aes( y = trend), colour = "blue") + 
  geom_vline(xintercept = major_holidays, lty = "dashed", alpha = 0.8) + 
  labs(y= "Total Flights", x = "Date", title = "Flight Trends across 4 Major Airlines in NYC")
```

The plot above illustrates the total number of flights per day across three major airports in NYC: JFK, LaGuardia, and EWK. The total flights are divided according to the four most popular airlines from the dataset.

While the data shows a generally stable trend, there is a noticeable weekly seasonal pattern, where weekends experience lower activity compared to weekdays (see supplementary information).

Overlaying the actual data are trendlines representing the flight trends for each airline. These trendlines offer insights into periods when airports experienced higher-than-usual activity. Notably, there are distinct dips in the flight count on specific dates.

To investigate these dips, an examination of the weather dataset was conducted, but no anomalies were found for these days. A list comprising major federal holidays in the US was then created. Plotting vertical lines to signify these dates indicated a correlation with some of the observed dips in total flights.

Additionaly, carrier B6 appears to be slightly more resilient to these holiday-related trends. This could be attributed to the fact that B6's primary airport is JFK, which is not the primary airport for any of the other major airlines plotted. However, further analysis would be needed to prove this hypothesis.



## Discussion

The visualisations above display this data coherently so that we can make statistical inferences from them. Approximating the distribution of a variable is a powerful initial step to delve further into prevailing relationships in data. In particular, we received insights into which airlines tended to have late arrivals, which locations were often flown into, and times of the year when sales increased. Airline companies could use such information for future planning needs. 

## References section

McInerney R, Thompson C, Ukachukwu O (2024). _densr: Overlay densities to
histograms_. R package version 0.1.0, <https://github.com/rachel-mc/densr>.  

R Core Team. (2023). R: A language and environment for statistical computing. R Foundation for Statistical Computing, Vienna, Austria. URL: https://www.R-project.org/  

Wickham H (2016). ggplot2: Elegant Graphics for Data Analysis. Springer-Verlag New York. ISBN 978-3-319-24277-4, https://ggplot2.tidyverse.org.  

Wickham H (2021). _nycflights13: Flights that Departed NYC in 2013_. R package version 1.0.2, <https://CRAN.R-project.org/package=nycflights13>.  

Wickham H, François R, Henry L, Müller K, Vaughan D (2023). _dplyr: A Grammar of Data Manipulation_. R package version 1.1.4, <https://CRAN.R-project.org/package=dplyr>.
